import t from"immer";import{createContext as e,useState as n,useRef as o,useEffect as r,createElement as i,PureComponent as c}from"react";var s={Actions:{},AsyncState:{},Context:{__global:{}},Middlewares:{},Setter:{classSetter:void 0,functionSetter:{}},State:{},devTools:void 0,subscriptions:{},uid:0,withDevTools:!1},a={logger:{enable:"production"!==process.env.NODE_ENV},devtools:{enable:"production"!==process.env.NODE_ENV},tryCatch:{enable:"production"===process.env.NODE_ENV}},u=function(t,e){try{var n=t.next,o=a.tryCatch.enable?Promise.resolve(n(e).catch(function(t){return console.log(t)})).then(function(){}):Promise.resolve(n(e)).then(function(){});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},l=function(t,e){try{var n=t.modelName,o=t.next,r=t.Global;return Promise.resolve((0,t.action)(t.params,Object.assign({},{actions:(0,t.consumerActions)(r.Actions[n],{modelName:n}),state:r.State[n]},r.Context.__global||{},r.Context[n]||{}))).then(function(n){return t.newState=n||null,Promise.resolve(o(e)).then(function(){})})}catch(t){return Promise.reject(t)}},f=function(t,e){try{var n=t.modelName,o=t.newState,r=t.next,i=function(){if(o)return w(n,o),Promise.resolve(r(e)).then(function(){})}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},m=function(t,e){try{var n=t.modelName,o=t.next,r=t.Global,i=t.__hash,c=r.Setter.functionSetter[n];return"function"===t.type&&i&&c&&c[i]&&c[i].setState&&c[i].setState(r.State[n]),Promise.resolve(o(e)).then(function(){})}catch(t){return Promise.reject(t)}},d=function(t,e){try{var n=t.next,o=t.Global.subscriptions[t.modelName+"_"+t.actionName];return o&&o.forEach(function(t){t()}),Promise.resolve(n(e)).then(function(){})}catch(t){return Promise.reject(t)}},S=function(t,e){try{var n=t.Global,o=!0===a.logger.enable||"function"==typeof a.logger.enable&&a.logger.enable(t)?(console.group("%c "+t.modelName+" State Change %c "+(new Date).toLocaleTimeString(),"color: gray; font-weight: lighter;","color: black; font-weight: bold;"),console.log("%c Previous","color: #9E9E9E; font-weight: bold",n.State[t.modelName]),console.log("%c Action","color: #03A9F4; font-weight: bold",t.actionName,"payload: "+t.params),Promise.resolve(t.next(e)).then(function(){console.log("%c Next","color: #4CAF50; font-weight: bold",n.State[t.modelName]),console.groupEnd()})):Promise.resolve(t.next(e)).then(function(){});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},v=function(t,e){try{var n=t.Global;return Promise.resolve(t.next(e)).then(function(){n.withDevTools&&a.devtools.enable&&n.devTools.send(t.modelName+"_"+t.actionName,n.State)})}catch(t){return Promise.reject(t)}},_=function(t,e){try{var n=t.modelName,o=t.next,r=t.actionName,i=t.Global;return i.Setter.classSetter&&i.Setter.classSetter(i.State),i.Setter.functionSetter[n]&&Object.keys(i.Setter.functionSetter[n]).map(function(t){var e=i.Setter.functionSetter[n][t];e&&(e.depActions&&-1===e.depActions.indexOf(r)||e.setState(i.State[n]))}),Promise.resolve(o(e)).then(function(){})}catch(t){return Promise.reject(t)}},h=[u,S,v,l,f,m,_,d],p={communicator:_,consoleDebugger:S,devToolsListener:v,getNewState:l,getNewStateWithCache:function(t){return void 0===t&&(t=5e3),function(e,n){try{var o=e.Global,r=e.modelName,i=e.next,c=e.actionName;return Promise.resolve(Promise.race([(0,e.action)(e.params,{actions:(0,e.consumerActions)(o.Actions[r],{modelName:r}),state:o.State[r]}),E(t,A(r,c))])).then(function(t){return e.newState=t||null,Promise.resolve(i(n)).then(function(){})})}catch(t){return Promise.reject(t)}}},setNewState:f,stateUpdater:m,subscription:d,tryCatch:u,config:a},b=function(t,e){try{e.next=function(t){return t.length>0&&t[0](e,t.slice(1))};var n=function(){if(t.length>0)return Promise.resolve(t[0](e,t.slice(1))).then(function(){})}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},g=e({}),y=g.Consumer;if(!console.group){var P=[],N="-".repeat(80);console.group=function(t){P.push(t),console.log("%c \nBEGIN GROUP: %c",N,t),console.groupEnd=function(){console.log("END GROUP: %c\n%c",P.pop(),N)}}}var O=function(t,e){var n={};return Object.entries(t).forEach(function(t){n[t[0]]=function(t,e){return function(n,o){try{return Promise.resolve(b(h,{Global:s,action:t,actionName:t.name,consumerActions:O,middlewareConfig:o,modelName:e.modelName,newState:null,params:n,type:"outer"})).then(function(){})}catch(t){return Promise.reject(t)}}}(t[1],e)}),n},w=function(e,n){if("function"==typeof n){var o=s.State[e];o=t(o,n),s.State=t(s.State,function(t){t[e]=o})}else s.State=t(s.State,function(t){t[e]=Object.assign({},t[e],n)});return s.State},E=function(t,e){return new Promise(function(n){return setTimeout(function(){console.log(t),n(e)},t)})},j=function(e,n){try{var o={__FROM_SERVER__:!0};return Promise.resolve(Promise.all(Object.keys(s.State).map(function(r){try{var i=function(){if(!e||!e.modelName||r===e.modelName||-1!==e.modelName.indexOf(r)){function i(e){n&&n.isServer?o[r]=e:s.State=t(s.State,function(t){t[r]=Object.assign({},t[r],e)})}var c=s.AsyncState[r];return c?Promise.resolve(c(e)).then(i):i({})}}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(t){return Promise.reject(t)}}))).then(function(){return n&&n.isServer?o:s.State})}catch(t){return Promise.reject(t)}},A=function(t,e){var n=localStorage.getItem("__REACT_MODELX__"+t+"_"+e);return n?JSON.parse(n):null},R=function(t){return void 0!==t.state},x=function(t){return void 0!==t.useStore};function C(e,n,o){if(R(e)){s.uid+=1;var r="__"+s.uid;s.State=t(s.State,function(t){t[r]=e.state}),e.middlewares&&(s.Middlewares[r]=e.middlewares),s.Actions[r]=e.actions,s.AsyncState[r]=e.asyncState,n&&(s.Context[r]=n);var i=M(r);return{__id:r,actions:i,getState:function(){return G(r)},subscribe:function(t,e){return D(r,t,e)},unsubscribe:function(t){return T(r,t)},useStore:function(t){return V(r,t)}}}if(e.actions){console.error("invalid model(s) schema: ",e);var c=function(t){return function(){for(var e=[],n=arguments.length;n--;)e[n]=arguments[n];return t}};return{__ERROR__:!0,actions:c({}),getActions:c({}),getInitialState:c({}),getState:c({}),subscribe:c(),unsubscribe:c(),useStore:c([{},{}])}}n&&!n.__FROM_SERVER__&&(s.State=t(s.State,function(t){Object.assign(t,n||{})})),o&&(s.Context.__global=o),Object.entries(e).forEach(function(e){var o=e[0],r=e[1];if(r.__ERROR__)return console.error(o+" model's schema is invalid"),s.State=t(s.State,function(t){t[o]={}}),void(s.Actions[o]={});x(r)?(s.State[o]&&n||(s.State=t(s.State,function(t){t[o]=t[r.__id]})),n&&n.__FROM_SERVER__&&(s.State=t(s.State,function(t){t[o]=Object.assign({},t[r.__id],n[o])})),s.Actions[o]=s.Actions[r.__id],s.AsyncState[o]=s.AsyncState[r.__id],s.Middlewares[o]=s.Middlewares[r.__id],s.Context[o]=s.Context[r.__id]):(n&&n.__FROM_SERVER__?s.State=t(s.State,function(t){t[o]=Object.assign({},r.state,n[o])}):s.State[o]||(s.State=t(s.State,function(t){t[o]=r.state})),r.middlewares&&(s.Middlewares[o]=r.middlewares),s.Actions[o]=r.actions,s.AsyncState[o]=r.asyncState)});var a=Object.keys(e).reduce(function(t,e){var n;return Object.assign({},t,((n={})[e]=M(e),n))},{});return s.withDevTools="undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION__,s.withDevTools&&(s.devTools=window.__REDUX_DEVTOOLS_EXTENSION__,s.devTools.connect()),{actions:a,getActions:M,getInitialState:j,getState:G,subscribe:D,unsubscribe:T,useStore:V}}var T=function(t,e){D(t,e,void 0)},D=function(t,e,n){Array.isArray(e)?e.forEach(function(e){s.subscriptions[t+"_"+e]||(s.subscriptions[t+"_"+e]=[]),n?s.subscriptions[t+"_"+e].push(n):s.subscriptions[t+"_"+e]=[]}):(s.subscriptions[t+"_"+e]||(s.subscriptions[t+"_"+e]=[]),n?s.subscriptions[t+"_"+e].push(n):s.subscriptions[t+"_"+e]=[])},G=function(t){return s.State[t]},M=function(t,e){void 0===e&&(e={type:"outer"});var n={};return Object.entries(s.Actions[t]).forEach(function(o){var r=o[0],i=o[1];return n[r]=function(n,o){try{var c=Object.assign({},{action:i,actionName:r,consumerActions:O,middlewareConfig:o,modelName:t,newState:null,params:n},e,{Global:s}),a=s.Middlewares[t]?Promise.resolve(b(s.Middlewares[t],c)).then(function(){}):Promise.resolve(b(h,c)).then(function(){});return Promise.resolve(a&&a.then?a.then(function(){}):void 0)}catch(t){return Promise.reject(t)}}}),n},V=function(t,e){var i=n({})[1],c=o("");r(function(){s.uid+=1;var n=""+s.uid;return c.current=n,s.Setter.functionSetter[t]||(s.Setter.functionSetter[t]={}),s.Setter.functionSetter[t][n]={setState:i,depActions:e},function(){delete s.Setter.functionSetter[t][n]}},[]);var a=M(t,{__hash:c.current,type:"function"});return[G(t),a]},F=function(t){function e(){t.apply(this,arguments),this.state=s.State}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.render=function(){var t=this.props.children;return s.Setter.classSetter=this.setState.bind(this),i(g.Provider,{value:Object.assign({},this.state)},t)},e}(c),I=function(t,e,n){return function(o){return function(r){function c(){r.apply(this,arguments)}return r&&(c.__proto__=r),(c.prototype=Object.create(r&&r.prototype)).constructor=c,c.prototype.render=function(){var r=this,c=this.props,a=c.state;void 0===a&&(a={});var u=c.actions;return void 0===u&&(u={}),i(y,null,function(c){var l=c[""+t],f=s.Actions[t];return i(o,Object.assign({},r.props,{state:Object.assign({},a,e?e(l):l),actions:Object.assign({},u,n?n(O(f,{modelName:t})):O(f,{modelName:t}))}))})},c}(c)}};export{h as actionMiddlewares,C as Model,p as middlewares,F as Provider,y as Consumer,I as connect,G as getState,j as getInitialState};
